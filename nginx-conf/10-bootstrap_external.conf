location = /bootstrap/install.sh {
  alias /opt/chefserver-internal-bootstrap-addon/www/install.sh;
  header_filter_by_lua 'ngx.header.content_length = nil';
  body_filter_by_lua '
    local host = ngx.req.get_headers()["Host"]
    ngx.arg[1] = ngx.re.gsub(ngx.arg[1], "https://www\\\\.opscode\\\\.com", "http://" .. host .. "/bootstrap")
    ngx.arg[2] = true -- EOF
  ';
}

location ~ ^/bootstrap/chef/metadata.* {
  rewrite ^/bootstrap(/.+) $1 break;
  proxy_pass https://www.opscode.com;
  header_filter_by_lua 'ngx.header.content_length = nil';
  body_filter_by_lua '
    local host = ngx.req.get_headers()["Host"]
    ngx.arg[1] = ngx.re.sub(ngx.arg[1], "^(url\\\\s+)https?://[^/]+/", "$1http://" .. host .. "/bootstrap/")
    ngx.arg[2] = true -- EOF
  ';
}
# vim: set ft=nginx:
